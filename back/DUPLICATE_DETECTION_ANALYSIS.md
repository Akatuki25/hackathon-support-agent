# 重複検知機能の分析レポート

**実行日時**: 2025-10-06 05:17-05:30  
**プロジェクトID**: c19b56b0-a1bc-46c6-969c-bbd86d7fb50e

---

## 🚨 重大な問題を発見

### 誤検知: 仕様書の機能を「重複」として削除

**削除された機能（一部抜粋）:**

| 機能コード | 機能名 | 削除理由 | ⚠️ 問題 |
|-----------|--------|---------|---------|
| F001 | テスト結果の登録 | 仕様書の「学習履歴の登録」と同一内容 | ❌ **誤削除** |
| F002 | 演習問題の解答履歴登録 | 仕様書の「学習履歴の登録」と同一内容 | ❌ **誤削除** |
| F003 | 課題への解答入力 | 仕様書の「課題への取り組みと記録」と同一内容 | ❌ **誤削除** |
| F004 | 課題の正誤記録 | 仕様書の「課題への取り組みと記録」と同一内容 | ❌ **誤削除** |
| F008 | 学力レベルの算出 | 仕様書の「学力と得意不得意の分析」と同一内容 | ❌ **誤削除** |
| F009 | 得意不得意の特定 | 仕様書の「学力と得意不得意の分析」と同一内容 | ❌ **誤削除** |
| F010 | 苦手克服課題の生成 | 仕様書の「個別最適化された課題生成」と同一内容 | ❌ **誤削除** |
| F016 | ユーザー登録 | 仕様書の「ユーザー認証」と同一内容 | ❌ **誤削除** |
| F017 | ログイン | 仕様書の「ユーザー認証」と同一内容 | ❌ **誤削除** |

---

## 📊 問題の分析

### 根本原因

**プロンプトの誤解**: LLMが「仕様書の要件」と「抽出された機能」の関係を誤認

```
LLMの誤った推論:
「仕様書に『学習履歴の登録』という大項目がある」
   ↓
「F001『テスト結果の登録』は学習履歴の一部だから重複」
   ↓
削除 ❌
```

**正しい理解:**
```
仕様書:「学習履歴の登録」（大項目）
   ↓ 詳細化
機能: F001「テスト結果の登録」（具体的な機能）
   ↓
これは詳細化であって重複ではない ✅
```

### プロンプトの問題点

```python:1391-1418
【重要な分析項目】
1. **網羅性**: 仕様書の要件をどの程度カバーしているか
2. **重複**: 機能名や内容が重複している機能がないか
   - 例: "ユーザー登録" と "新規ユーザー登録" は重複  ← これは正しい
   - 例: "データ保存" と "データベース保存" は重複の可能性  ← これは正しい
3. **抜け漏れ**: 仕様書にあるが機能リストにない要件
```

**問題**: 「仕様書の大項目」と「抽出された詳細機能」の区別が不明確

---

## 🔍 実際の重複検知結果

### ケース1: 誤削除（大多数）

```
削除理由: "仕様書の「学習履歴の登録」における演習問題解答履歴登録機能と同一内容"
                    ↑                                 ↑
                仕様書の大項目                      抽出された機能

判定: ❌ 誤削除
理由: これは「詳細化」であって「重複」ではない
```

### ケース2: 正しい重複検知（少数）

先ほどのログ（05:28:02以降）を見ると:

```
F022: AIによる丁寧な解説の提供
F036: AIによる丁寧な解説提供
削除理由: "機能名と説明が完全に一致"

判定: ✅ 正しい重複検知
```

```
F038: 動的な難易度・出題形式調整
F039: 難易度調整
F040: 出題形式調整
削除理由: "F038が包括的で重複"

判定: ✅ 正しい重複検知
```

---

## 📈 削除結果の統計

### 実行1回目（05:17-05:18）: 誤削除が多い

| 項目 | 値 |
|------|-----|
| 削除数 | 15個以上 |
| 誤削除（推定） | **12-13個 (80-85%)** |
| 正しい削除 | 2-3個 (15-20%) |

### 実行2回目（05:28-05:30）: 比較的正確

| 項目 | 値 |
|------|-----|
| 削除数 | 15個以上 |
| 誤削除（推定） | **3-5個 (20-30%)** |
| 正しい削除 | 10-12個 (70-80%) |

**差異の原因**: 
- 1回目: 仕様書の大項目と抽出機能を比較（誤削除多い）
- 2回目: 抽出機能同士を比較（正確性向上）

---

## 🛠️ 修正方針

### 問題の整理

1. **仕様書の大項目 vs 抽出機能の混同**
   - 例: 「学習履歴の登録」（大項目） vs 「テスト結果の登録」（機能）
   - これは詳細化であって重複ではない

2. **重複の定義が不明確**
   - 本当の重複: 「ユーザー登録」 vs 「新規ユーザー登録」
   - 詳細化: 「学習履歴の登録」（大項目） vs 「テスト結果の登録」（詳細）

### 修正案

#### Option 1: プロンプトの改善（推奨）

```python
【重複の定義】
以下の場合のみ「重複」と判定してください:

✅ 重複と判定すべき例:
- "ユーザー登録" と "新規ユーザー登録"
  → 同じ機能を表現している
- "AIによる解説の提供" と "AIによる丁寧な解説提供"
  → 完全に同一の機能
- "難易度調整" と "難易度の動的調整"
  → 同じ機能（表現が異なるだけ）

❌ 重複ではない例（詳細化）:
- 大項目「学習履歴の登録」 vs 詳細機能「テスト結果の登録」
  → 大項目を詳細化したもの
- 大項目「ユーザー認証」 vs 詳細機能「ログイン」「ユーザー登録」
  → 大項目を具体的な機能に分解したもの

【重要】
- 機能リスト内の機能同士のみを比較してください
- 仕様書の大項目は参照情報であり、削除対象ではありません
```

#### Option 2: 重複検知の2段階アプローチ

```python
# ステップ1: 明らかな重複のみ検知（厳密モード）
duplicate_detection_mode = "strict"  # "strict" or "loose"

if mode == "strict":
    # 機能名の類似度 > 80% かつ 説明の類似度 > 70%
    # のみを重複と判定
```

#### Option 3: 人間による確認ステップ

```python
# 削除前に確認プロンプトを表示
if duplicate_detected:
    return f"""
    重複候補を検出しました:
    - {function_name}
    - 理由: {reason}
    
    削除する場合は delete_duplicate_function を呼び出してください。
    削除しない場合は次のステップに進んでください。
    """
```

---

## 🎯 推奨される対応

### 即時対応（Priority 1）

1. **プロンプトの修正**
   ```python
   # 1382-1419行を修正
   coverage_prompt = f"""
   ...
   【重複の定義 - 重要】
   ⚠️ 以下の区別に注意してください:
   
   1. **機能同士の重複**（削除対象）:
      - 機能リスト内で、同じ内容を表す複数の機能
      - 例: "ユーザー登録" と "新規ユーザー登録"
   
   2. **詳細化**（削除対象外）:
      - 仕様書の大項目を具体的な機能に分解したもの
      - 例: 「学習履歴の登録」→「テスト結果の登録」「演習問題履歴登録」
      - これらは削除してはいけません
   
   **重複検知ルール**:
   - 機能リスト内の機能同士のみを比較
   - 仕様書の大項目との比較はしない
   - 機能名の類似度が80%以上 かつ 説明が実質的に同じ場合のみ重複と判定
   """
   ```

2. **検証ステップの追加**
   ```python
   # 削除前に再確認
   if duplicate_detected:
       # 本当に重複か再確認するプロンプト
       confirmation = llm.invoke(f"""
       以下は本当に重複ですか？
       機能1: {func1}
       機能2: {func2}
       
       以下の場合は「重複ではない」と答えてください:
       - 片方が他方の詳細化・具体化である場合
       - 仕様書の大項目と抽出機能の関係である場合
       """)
   ```

### 中期対応（Priority 2）

1. **削除履歴の記録と復元機能**
   ```python
   # 削除した機能を一時保存
   deleted_functions_history = []
   
   # 必要に応じて復元
   def restore_function(function_id):
       # ...
   ```

2. **重複検知の精度測定**
   ```python
   # テストセットで精度を測定
   # Precision, Recall, F1スコアを算出
   ```

---

## 結論

### ✅ 成功した点

- 重複検知機能は実装され、動作している
- 一部の重複は正しく検知・削除されている

### ❌ 失敗した点

- **誤削除率が高い（80-85%）**
- 仕様書の大項目と抽出機能を混同
- 詳細化を重複と誤認

### 🔧 必須の修正

**プロンプトの改善が緊急に必要**:
1. 重複の定義を明確化
2. 機能同士のみを比較するよう指示
3. 詳細化と重複の区別を明示

---

**担当者**: AI Assistant  
**優先度**: 🔴 HIGH（誤削除により重要機能が失われる可能性）  
**次のアクション**: プロンプト修正 → 再テスト

